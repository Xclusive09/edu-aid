<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EDU_AID - Login</title>

  <!-- Tailwind + Custom Styles -->
  <link href="css/styles.css" rel="stylesheet" />

  <!-- Lucide Icons (UMD) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <meta name="description" content="EDU_AID - AI-Powered Educational Analytics Platform" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>Graduation Cap</text></svg>" />

  <style>
    .bg-pattern {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    }
    .animate-fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }
    .animate-slide-in-down { animation: slideInDown 0.4s ease-out; }
    @keyframes slideInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: none; } }
    .loading-spinner {
      width: 1rem; height: 1rem; border: 2px solid #fff; border-top-color: transparent;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { @apply fixed bottom-6 right-6 bg-white shadow-xl rounded-xl p-4 flex items-center gap-3 max-w-sm transition-all; }
    .toast-enter { opacity: 0; transform: translateY(20px); }
    .toast-enter-active { opacity: 1; transform: none; }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center px-4 bg-pattern font-sans">

  <!-- Animated Background -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-32 -right-32 w-96 h-96 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full opacity-20 blur-3xl animate-pulse"></div>
    <div class="absolute -bottom-32 -left-32 w-96 h-96 bg-gradient-to-tr from-indigo-400 to-cyan-500 rounded-full opacity-20 blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
  </div>

  <!-- Login Card -->
  <div class="relative w-full max-w-md animate-fade-in">
    <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 border border-white/20">

      <!-- Header -->
      <div class="text-center mb-8">
        <div class="mx-auto w-20 h-20 bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 rounded-3xl flex items-center justify-center mb-6 shadow-xl">
          <span class="text-3xl">Graduation Cap</span>
        </div>
        <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">EDU_AID</h1>
        <p class="text-gray-600 font-medium">Educational AI Assistant</p>
      </div>

      <!-- Form -->
      <form id="loginForm" class="space-y-6">
        <!-- Email -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
            <i data-lucide="mail" class="w-4 h-4 mr-2 text-blue-600"></i>
            Email Address
          </label>
          <div class="relative">
            <i data-lucide="at-sign" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
            <input type="email" id="email" required
                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                   placeholder="admin@edu-aid.com" autocomplete="email" />
          </div>
        </div>

        <!-- Password -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
            <i data-lucide="lock" class="w-4 h-4 mr-2 text-blue-600"></i>
            Password
          </label>
          <div class="relative">
            <i data-lucide="key" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
            <input type="password" id="password" required
                   class="w-full pl-10 pr-12 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                   placeholder="••••••••" autocomplete="current-password" />
            <button type="button" id="togglePassword"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
              <i data-lucide="eye" class="w-5 h-5"></i>
            </button>
          </div>
        </div>

        <!-- Remember + Forgot -->
        <div class="flex items-center justify-between text-sm">
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="rememberMe" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
            <span class="ml-2 text-gray-700">Remember me</span>
          </label>
          <a href="#" class="text-blue-600 hover:text-blue-500 font-medium">Forgot password?</a>
        </div>

        <!-- Submit -->
        <button type="submit" id="loginBtn"
                class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all group flex items-center justify-center">
          <span id="loginText">Sign In</span>
          <i data-lucide="arrow-right" class="ml-2 w-5 h-5 group-hover:translate-x-1 transition"></i>
          <div id="loginSpinner" class="hidden ml-2 loading-spinner"></div>
        </button>
      </form>

      <!-- Demo Accounts -->
      <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
        <div class="text-center mb-3">
          <i data-lucide="info" class="w-5 h-5 text-blue-600 mx-auto"></i>
          <p class="text-xs font-semibold text-blue-900 mt-1">Test Accounts</p>
        </div>
        <div class="space-y-2 text-xs">
          <div class="bg-white/70 p-2 rounded border">
            <strong>Admin:</strong> admin@edu-aid.com / admin123
          </div>
          <div class="bg-white/70 p-2 rounded border">
            <strong>Teacher:</strong> teacher@edu-aid.com / teacher123
          </div>
          <div class="bg-white/70 p-2 rounded border">
            <strong>Student:</strong> student@edu-aid.com / student123
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div id="errorMessage" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-xl flex items-center gap-2">
        <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
        <span id="errorText" class="text-sm text-red-800 font-medium"></span>
      </div>

      <div id="successMessage" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-xl flex items-center gap-2">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
        <span class="text-sm text-green-800 font-medium">Login successful! Redirecting...</span>
      </div>
    </div>

    <!-- Footer -->
    <p class="text-center mt-6 text-xs text-gray-500">
      © 2025 EDU_AID. Powered by Google Gemini AI.
    </p>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden toast-enter">
    <div class="flex items-center gap-3">
      <div id="toastIcon"></div>
      <p id="toastMessage" class="text-sm font-medium"></p>
      <button id="closeToast" class="text-gray-400 hover:text-gray-600">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/auth.js"></script>
  <script src="js/api.js"></script>
  <script>
    // Initialize Lucide
    lucide.createIcons();

    class LoginManager {
      constructor() { this.init(); }

      init() {
        console.log('Initializing login page...');
        
        // Check localStorage contents
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        console.log('Found token:', !!token, 'Found user:', !!user);
        
        // Only redirect if both token and user exist AND token is valid
        if (token && user) {
          try {
            const tokenData = JSON.parse(atob(token));
            if (tokenData.exp > Date.now()) {
              console.log('Valid session found, redirecting to dashboard');
              window.location.href = 'dashboard.html';
              return;
            } else {
              console.log('Token expired, clearing session');
              localStorage.removeItem('token');
              localStorage.removeItem('user');
            }
          } catch (error) {
            console.log('Invalid token, clearing session');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
          }
        }
        
        console.log('User not authenticated, showing login form');
        this.setupEvents();
      }

      setupEvents() {
        const form = document.getElementById('loginForm');
        const toggle = document.getElementById('togglePassword');
        const closeToast = document.getElementById('closeToast');

        form.addEventListener('submit', this.handleLogin.bind(this));
        toggle.addEventListener('click', this.togglePassword.bind(this));
        closeToast.addEventListener('click', () => this.hideToast());
      }

      async handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const remember = document.getElementById('rememberMe').checked;

        if (!email || !password) return this.showError('Please fill all fields');

        this.setLoading(true);
        this.hideMessages();

        try {
          const res = await api.login(email, password);

          // Extend token if "Remember Me"
          if (remember) {
            const token = localStorage.getItem('token');
            const payload = JSON.parse(atob(token.split('.')[0])); // rough decode
            payload.exp = Date.now() + 30 * 24 * 60 * 60 * 1000;
            localStorage.setItem('token', btoa(JSON.stringify(payload)));
          }

          this.showSuccess();
          setTimeout(() => window.location.href = 'dashboard.html', 1200);
        } catch (err) {
          this.showError(err.message || 'Login failed');
          this.setLoading(false);
        }
      }

      togglePassword() {
        const field = document.getElementById('password');
        const icon = document.querySelector('#togglePassword i');
        const isPass = field.type === 'password';
        field.type = isPass ? 'text' : 'password';
        icon.setAttribute('data-lucide', isPass ? 'eye-off' : 'eye');
        lucide.createIcons();
      }

      setLoading(loading) {
        const btn = document.getElementById('loginBtn');
        const text = document.getElementById('loginText');
        const spin = document.getElementById('loginSpinner');
        const arrow = document.querySelector('#loginBtn i[data-lucide="arrow-right"]');

        btn.disabled = loading;
        text.textContent = loading ? 'Signing in...' : 'Sign In';
        spin.classList.toggle('hidden', !loading);
        arrow.classList.toggle('hidden', loading);
      }

      showError(msg) {
        const el = document.getElementById('errorMessage');
        document.getElementById('errorText').textContent = msg;
        el.classList.remove('hidden');
      }

      showSuccess() {
        document.getElementById('successMessage').classList.remove('hidden');
      }

      hideMessages() {
        document.querySelectorAll('#errorMessage, #successMessage').forEach(el => el.classList.add('hidden'));
      }

      showToast(msg, type = 'info') {
        const toast = document.getElementById('toast');
        const iconEl = document.getElementById('toastIcon');
        const msgEl = document.getElementById('toastMessage');

        const icons = { success: 'check-circle', error: 'x-circle', info: 'info' };
        const colors = { success: 'text-green-600', error: 'text-red-600', info: 'text-blue-600' };

        msgEl.textContent = msg;
        iconEl.innerHTML = `<i data-lucide="${icons[type]}" class="w-5 h-5 ${colors[type]}"></i>`;
        toast.classList.remove('hidden', 'toast-enter');
        toast.classList.add('toast-enter-active');
        lucide.createIcons();

        setTimeout(() => this.hideToast(), 3000);
      }

      hideToast() {
        const toast = document.getElementById('toast');
        toast.classList.remove('toast-enter-active');
        toast.classList.add('toast-enter');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }
    }

    // Start
    document.addEventListener('DOMContentLoaded', () => new LoginManager());
  </script>
</body>
</html>